#!/bin/sh
# Auto-configure git-branchless and git-machete on checkout/clone.

. "$HOOKS_DIR/core/lib.sh"

PREV_HEAD="$1"
NEW_HEAD="$2"
FLAG="$3"

# Only run on branch checkout (1)
if [ "$FLAG" != "1" ]; then
    exit 0
fi

# --- 1. Git Branchless Initialization ---
if command -v git-branchless >/dev/null 2>&1; then
    # Check if branchless is already initialized via config include
    # 'git branchless init' typically adds [include] path = branchless/config to .git/config
    # We check if that specific config file exists to avoid re-running init unnecessarily.
    if [ ! -f "$GIT_DIR/branchless/config" ]; then
        log_info "Initializing git-branchless..."
        
        main_branch=$(get_main_branch "origin")
        
        # Run init. This will:
        # 1. Create .git/branchless/config
        # 2. Add include to .git/config
        # 3. Potentially update hooks (we assume user handles hook conflicts/symlinks if they want this)
        if git branchless init --main-branch "$main_branch"; then
            log_info "git-branchless initialized for main branch: $main_branch"
        else
            log_error "Failed to initialize git-branchless"
        fi
    fi
fi
