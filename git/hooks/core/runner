#!/bin/sh

# Git Hook Runner

SCRIPT_NAME=$(basename "$0")
export HOOK_NAME="$SCRIPT_NAME"

current_dir=$(cd "$(dirname "$0")" && pwd)
export HOOKS_DIR="$current_dir"

# Search for lib.sh
if [ -f "$current_dir/core/lib.sh" ]; then
    LIB_PATH="$current_dir/core/lib.sh"
elif [ -f "$current_dir/../core/lib.sh" ]; then
    LIB_PATH="$current_dir/../core/lib.sh"
else
    echo "Git Hooks Error: Cannot find core/lib.sh functionality."
    exit 1
fi

. "$LIB_PATH"

HOOK_DIR="$current_dir/$HOOK_NAME.d"

# Handle STDIN buffering for hooks that consume input
# pre-push, post-rewrite, push-to-checkout, pre-receive, post-receive, reference-transaction
NEEDS_STDIN=0
case "$HOOK_NAME" in
    pre-push|post-rewrite|push-to-checkout|pre-receive|post-receive|reference-transaction)
        NEEDS_STDIN=1
        ;;
esac

STDIN_FILE=""
if [ "$NEEDS_STDIN" -eq 1 ]; then
    # We must read stdin into a temp file
    # mktemp is POSIX-ish (standard on linux/bsd/macos)
    STDIN_FILE=$(mktemp)
    cat > "$STDIN_FILE"
fi

run_hook_overlays "$HOOKS_DIR" "$HOOK_NAME" "$STDIN_FILE" "$@"
run_local_hook "$HOOK_NAME" "$STDIN_FILE" "$@"

if [ -n "$STDIN_FILE" ] && [ -f "$STDIN_FILE" ]; then
    rm "$STDIN_FILE"
fi

exit 0
